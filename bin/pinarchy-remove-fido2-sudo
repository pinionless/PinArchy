#!/bin/bash

# FIDO2 sudo component removal functions for PinArchy
# This file is sourced by pinarchy-remove-fido2

# Function to get security icon based on sudo authfile path
get_security_icon() {
  local authfile="$1"
  case "$authfile" in
    "/etc/fido2/sudo-no-touch") echo "" ;;  # No icon for no requirements
    "/etc/fido2/sudo-touch-required") echo "üëÜ" ;;
    "/etc/fido2/sudo-pin-required") echo "üî¢" ;;
    "/etc/fido2/sudo-touch-pin-required") echo "üëÜüî¢" ;;
    *) echo "‚ùì" ;;  # Unknown authfile
  esac
}

# Function to get sudo keys from keymap-sudo
get_sudo_keys() {
  local keys=()
  local display_keys=()
  local keymap_file="/etc/fido2/keymap-sudo"
  
  # Check if keymap file exists
  if [[ ! -f "$keymap_file" ]]; then
    FILTERED_KEYS=()
    DISPLAY_KEYS=()
    return 0
  fi
  
  # Read keymap and filter for sudo keys
  while IFS=: read -r keyname authfile key_hash timestamp; do
    # Skip empty lines and comments
    [[ -z "$keyname" || "$keyname" =~ ^[[:space:]]*# ]] && continue
    
    # Filter for sudo keys (in /etc/fido2/sudo-* authfiles)
    if [[ "$authfile" =~ ^/etc/fido2/sudo-(no-touch|touch-required|pin-required|touch-pin-required)$ ]]; then
      keys+=("$keyname:$authfile:$key_hash:$timestamp")
      
      # Format for display: keyname + date + icon
      local date_only=$(echo "$timestamp" | cut -d' ' -f1)
      local security_icon=$(get_security_icon "$authfile")
      local display_text="$keyname"
      [[ -n "$date_only" ]] && display_text="$display_text    $date_only"
      [[ -n "$security_icon" ]] && display_text="$display_text    $security_icon"
      
      display_keys+=("$display_text")
    fi
  done < "$keymap_file"
  
  # Return both arrays via global variables
  FILTERED_KEYS=("${keys[@]}")
  DISPLAY_KEYS=("${display_keys[@]}")
}

# Function to remove sudo keys
remove_sudo_keys() {
  local selected_keys=("$@")
  local keymap_file="/etc/fido2/keymap-sudo"
  
  echo "üóëÔ∏è  Removing selected sudo keys..."
  
  # Remove keys from authfiles and keymap
  for key_data in "${selected_keys[@]}"; do
    keyname=$(echo "$key_data" | cut -d: -f1)
    authfile=$(echo "$key_data" | cut -d: -f2)
    key_hash=$(echo "$key_data" | cut -d: -f3)
    
    # Remove from keymap file - find line by keyhash and delete by line number
    if [[ -f "$keymap_file" ]]; then
      line_number=$(grep -n ":$key_hash:" "$keymap_file" | cut -d: -f1)
      if [[ -n "$line_number" ]]; then
        sudo sed -i "${line_number}d" "$keymap_file"
      fi
    fi
    
    # Remove from authfile (complex - remove specific key from user line)
    if [[ -f "$authfile" ]]; then
      # Get current user to find their line in authfile
      current_user=$(whoami)
      
      # Check if user has entries in this authfile
      if sudo grep -q "^$current_user:" "$authfile"; then
        # Get user's current line
        user_line=$(sudo grep "^$current_user:" "$authfile")
        
        # Extract all key data (everything after username:)
        all_keys=$(echo "$user_line" | cut -d: -f2-)
        
        # Split keys by colon and rebuild line without the target key
        # We need to match by key handle (first part before comma)
        IFS=':' read -ra key_array <<< "$all_keys"
        new_keys=()
        
        for key_entry in "${key_array[@]}"; do
          # Extract key handle from this entry
          if [[ "$key_entry" =~ ^([^,]+), ]]; then
            entry_key_handle="${BASH_REMATCH[1]}"
            entry_hash=$(echo "$entry_key_handle" | sha256sum | cut -c1-10)
            
            # Keep this key if hash doesn't match the one we're removing
            if [[ "$entry_hash" != "$key_hash" ]]; then
              new_keys+=("$key_entry")
            fi
          fi
        done
        
        # Rebuild user line with remaining keys
        if [[ ${#new_keys[@]} -gt 0 ]]; then
          # User has remaining keys - update their line
          new_user_line="$current_user:$(IFS=:; echo "${new_keys[*]}")"
          sudo sed -i "s|^$current_user:.*|$new_user_line|" "$authfile"
        else
          # User has no remaining keys - remove their line entirely  
          sudo sed -i "/^$current_user:/d" "$authfile"
        fi
      fi
    fi
  done
}