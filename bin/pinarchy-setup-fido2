#!/bin/bash

set -e

# FIDO2 Management Script for PinArchy  
# Enhanced FIDO2/YubiKey configuration with multiple options

echo "üîê PinArchy FIDO2 Management"
echo

# Define available FIDO2 components
COMPONENTS=(
  "login-sudo"
  "ssh"
  "luks"
)

# Use gum for consistent multi-select interface
SELECTED_STRING=$(gum choose --no-limit --header "Select FIDO2 components to configure..." --selected-prefix="‚úó " "${COMPONENTS[@]}")

# Convert newline-separated string to array
SELECTED=()
while IFS= read -r line; do
  [[ -n "$line" ]] && SELECTED+=("$line")
done <<< "$SELECTED_STRING"

if [[ ${#SELECTED[@]} -eq 0 ]]; then
  echo "No components selected. Exiting."
  exit 0
fi

echo
echo "Authentication options:"

# Separate checkboxes for authentication requirements
OPTIONS_STRING=$(gum choose --no-limit --header "Select authentication requirements..." --selected-prefix="‚úì " "touch-required" "pin-required")

# Convert options to array
OPTIONS=()
while IFS= read -r line; do
  [[ -n "$line" ]] && OPTIONS+=("$line")
done <<< "$OPTIONS_STRING"

echo
echo "Selected components:"
for component in "${SELECTED[@]}"; do
  case "$component" in
    "login-sudo") echo "  üîê login-sudo - System authentication (login + sudo + GUI admin)" ;;
    "ssh") echo "  üîë ssh - Hardware-backed SSH keys" ;;
    "luks") echo "  üíæ luks - Disk encryption with FIDO2" ;;
  esac
done

echo
echo "Authentication requirements:"
for option in "${OPTIONS[@]}"; do
  case "$option" in
    "touch-required") echo "  üëÜ touch-required - Physical touch needed for authentication" ;;
    "pin-required") echo "  üî¢ pin-required - PIN entry required for authentication" ;;
  esac
done

if [[ ${#OPTIONS[@]} -eq 0 ]]; then
  echo "  ‚ö° No additional requirements - Presence-only authentication"
fi

echo
echo "Configuration will be implemented in future version."
echo "Press any key to continue..."
read -n 1 -s