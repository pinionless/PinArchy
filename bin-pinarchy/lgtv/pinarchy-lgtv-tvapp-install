#!/bin/bash

# LG TV App Installer for PinArchy
# Creates desktop launcher for TV apps

set -e

TV_IP="$1"

main() {
  while true; do
    if [[ -t 0 && -t 1 ]]; then
      clear
      omarchy-show-logo
      echo "üì∫ LG TV App Installer"
    fi

    local config_file="$HOME/.config/lgtv/config.json"

    # Source library functions
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    source "$SCRIPT_DIR/fn-lgtv-apps.sh"

    # Get list of configured TVs
    tv_count=$(jq '.tvs | length' "$config_file")
    if [ "$tv_count" -eq 0 ]; then
      echo
      echo "‚ùå No TVs configured"
      echo "   Run 'pinarchy-lgtv-setup' to add a TV first"
      return
    fi

    if [ -n "$TV_IP" ]; then
      tv_name=$(jq -r '.tvs[0].name' "$config_file")
      echo "   IP: $TV_IP"
    elif [ "$tv_count" -eq 1 ]; then
      TV_IP=$(jq -r '.tvs[0].ip' "$config_file")
      tv_name=$(jq -r '.tvs[0].name' "$config_file")
      echo "   IP: $TV_IP"
    else
      mapfile -t TV_LIST < <(pinarchy-lgtv-list)
      OPTIONS+=("${TV_LIST[@]/#/Ôâ¨  }")
      SELECTED=$(gum choose --header "Select TV to install app for:" "${OPTIONS[@]}")
      TV_IP=$(echo "$SELECTED" | grep -o '([^)]*)' | tr -d '()')
      tv_name=$(echo "$SELECTED" | sed 's/ ([^)]*)$//')
      echo "   IP: $TV_IP"
    fi

    echo
    if ! add_tvapp "$TV_IP"; then
      return
    fi
    omarchy-show-done
  done
}

main