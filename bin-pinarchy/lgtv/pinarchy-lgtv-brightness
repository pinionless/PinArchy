#!/bin/bash

# LG TV Brightness Control
# Usage: pinarchy-lgtv-brightness <TV_IP>

set -e

TV_IP="$1"

main() {
  if [[ -t 0 && -t 1 ]]; then
    if [ -z "$TV_IP" ]; then
      echo "‚ùå Usage: pinarchy-lgtv-brightness <TV_IP>"
      exit 1
    fi
    clear
    omarchy-show-logo
    echo "üì∫ LG TV Brightness Control"
    echo "   IP: $TV_IP"
    echo
  fi

  SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
  source "$SCRIPT_DIR/fn-lgtv-brightness.sh"
  
  local config_file="$HOME/.config/lgtv/config.json"
  
  local brightness=$(jq -r --arg ip "$TV_IP" '.tvs[] | select(.ip == $ip) | .enabled_features.brightness_control' "$config_file")

  if [ -z "$brightness" ]; then
    echo "‚ùå TV with IP $TV_IP not found in configuration"
    return
  fi

  if "$brightness"; then
    echo "Current status: ‚úÖ Waybar brightness control is ENABLED"
  else
    echo "Current status: ‚ùå Waybar brightness control is DISABLED"
  fi
  echo
  
  # Show enable/disable confirmation with custom buttons
  if gum confirm "Waybar brightness control for this TV:" --affirmative="Enable" --negative="Disable"; then
    # Get brightness step from user
    BRIGHTNESS_STEP=$(gum input --placeholder "Enter brightness step (1-100)" --prompt "Step: ")
    
    if [ -z "$BRIGHTNESS_STEP" ]; then
      echo "‚ùå Brightness step is required"
      return
    fi
    
    add_brightness_control "$TV_IP" "$BRIGHTNESS_STEP"
  else
    remove_brightness_control "$TV_IP"
  fi
}

main