#!/bin/bash

set -e

# Add new LG TV configuration
# Interactive script to add a new TV to the system

main() {
  if [[ -t 0 && -t 1 ]]; then
    clear
    omarchy-show-logo
    echo "📺 Add New LG TV"
    echo
  fi
  config_file="$HOME/.config/lgtv/config.json"

  # Step 1: Ask for TV IP address
  TV_IP=$(gum input --placeholder "Enter TV IP address (e.g., 192.168.1.100)")

  if [ -z "$TV_IP" ]; then
    echo "❌ IP address is required"
    return
  fi

  echo "📡 Using IP: $TV_IP"
  echo

  # Step 2: Check if TV already exists in config
  existing_tv_name=$(jq -r --arg ip "$TV_IP" '.tvs[] | select(.ip == $ip) | .name' "$config_file" 2>/dev/null)
  if [ -n "$existing_tv_name" ]; then
    existing_tv_date=$(jq -r --arg ip "$TV_IP" '.tvs[] | select(.ip == $ip) | .date_added' "$config_file" 2>/dev/null)
    echo "❌ TV with IP $TV_IP already exists"
    echo "   TV name: $existing_tv_name"
    echo "   Added: $existing_tv_date"
    return
  fi

  # Step 3: Connection test
  echo "🔌 Testing connection to TV..."
  if ! pinarchy-lgtv-connect "$TV_IP"; then
    echo "❌ Failed to connect to TV. Please check the IP address and try again."
    return
  fi
  echo

  # Step 4: Ask for TV Name
  TV_NAME=$(gum input --placeholder "Enter TV name (e.g., Living Room TV)")

  if [ -z "$TV_NAME" ]; then
  echo "❌ TV name is required"
    return
  fi

  echo "📺 TV Name: $TV_NAME"
  echo

  # Step 5: Get MAC address
  echo "🔍 Getting MAC address..."
  ping -c 1 -W 1 "$TV_IP" >/dev/null 2>&1 || true

  MAC_ADDRESS=$(ip neigh show "$TV_IP" 2>/dev/null | grep -o '[0-9a-f]\{2\}:[0-9a-f]\{2\}:[0-9a-f]\{2\}:[0-9a-f]\{2\}:[0-9a-f]\{2\}:[0-9a-f]\{2\}' | head -1)

  if [ -z "$MAC_ADDRESS" ]; then
    echo "❌ Could not auto-detect MAC address."
    echo "💡 Find MAC address in TV Settings → Network → Advanced Settings"
    MAC_ADDRESS=$(gum input --placeholder "Enter MAC address (aa:bb:cc:dd:ee:ff)" --prompt "MAC Address: ")

    if [ -z "$MAC_ADDRESS" ]; then
      echo "❌ MAC address is required"
      return
    fi
    else
      echo "📍 MAC Address: $MAC_ADDRESS"
  fi
  echo

  # Step 6: Save to JSON config file
  local datetime=$(date '+%Y-%m-%d %H:%M:%S')

  # Create new TV object and add to config
  local new_tv=$(jq -n \
  --arg ip "$TV_IP" \
      --arg name "$TV_NAME" \
      --arg mac "$MAC_ADDRESS" \
      --arg date "$datetime" \
      '{
      ip: $ip,
      name: $name,
      mac: $mac,
      date_added: $date,
      enabled_features: {
          waybar_volume_control: false,
          brightness_control: false
      }
      }')
  
  # Add to existing config
  jq --argjson new_tv "$new_tv" '.tvs += [$new_tv]' "$config_file" > "$config_file.tmp" && mv "$config_file.tmp" "$config_file"
  
  echo "✅ TV saved to configuration"
}

main